
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "SVC_HUBBLE"."VW_AUTH_PRODUCT_REG" ("R_OBJECT_ID", "R_INDEX", "AUTHORISATION_HOLDER_NAME", "AUTHORISATION_HOLDER_UID", "AUTHORISATION_STATUS", "AUTHORISATION_STATUS_DATE", "AUTHORISATION_TYPE", "DATE_OF_FIRST_AUTHORISATION", "AUTHORIZATION_COUNTRY", "MARKET_NAME", "REVIEWING_MARKET_NAME", "PRODUCT_FAMILY_NAME", "PRODUCT_FAMILY_UID", "REGULATORY_APPLICATION_NAME", "REGULATORY_APPLICATION_UID", "VALIDITY_PERIOD_END", "VALIDITY_PERIOD_START", "VALIDITY_PERIOD", "MEDICINAL_PRODUCT_NAME", "PACKAGED_PRODUCT_NAME", "R_CREATOR_NAME", "R_MODIFY_DATE", "R_MODIFIER", "R_CREATION_DATE", "BUSINESS_UNIT", "CONCEPT", "INFORMATION_CLASSIFICATION", "SECURITY_DOMAIN", "IS_ACTIVE", "AUTHORIZATION_NUMBER", "APPLICATION_NUMBER", "APPLICATION_TYPE_NAME", "TYPE_OF_PROCEDURE", "BASE_APPLICATION_TYPE", "TRADE_NAME", "DOSE_FORM_NAME", "REGULATORY_APPLICATION_R_OBJECT_ID", "DOSE_STRENGTH_NAME", "CLASSIFICATION_DOMAIN", "CLASSIFICATION_GROUP", "CLASSIFICATION_SUBGROUP", "DOCUMENT_URL", "SPECIAL_DESIGNATION", "SPECIAL_DESIGNATION_DATE", "INDICATION_STATUS_DATE", "INDICATION_STATUS", "ROSTER_REGION", "IS_EEA", "IS_EU", "TA") DEFAULT COLLATION "USING_NLS_COMP"  AS 
  WITH TR
        AS (SELECT DISTINCT MEDICINAL_PRODUCT_UID,
                            TRADE_NAME,
                            DOSE_FORM_NAME,
                            DOSE_STRENGTH_NAME,
                            MARKET_UID,
                            PRODUCT_FAMILY_UID,
                            HISTORIC_NAME_VALUE,
                            CLASSIFICATION_DOMAIN,
                            CLASSIFICATION_GROUP,
                            CLASSIFICATION_SUBGROUP
              FROM COSMOSDBEXPORT.PRODUCT_R, COSMOSDBEXPORT.PRODUCT
             WHERE PRODUCT_R_OBJECT_ID = R_OBJECT_ID),
             first_view as (
SELECT DISTINCT
       A.R_OBJECT_ID,
       B.R_INDEX,
       A.AUTHORISATION_HOLDER_NAME,
       A.AUTHORISATION_HOLDER_UID,
       A.AUTHORISATION_STATUS,
       A.AUTHORISATION_STATUS_DATE,
       A.AUTHORISATION_TYPE,
       A.DATE_OF_FIRST_AUTHORISATION,
       A.MARKET_NAME AS AUTHORIZATION_COUNTRY,
       NVL (C.MARKET_NAME, A.MARKET_NAME) AS market_name,
       NVL (C.REVIEWING_MARKET_NAME, A.MARKET_NAME) AS REVIEWING_MARKET_NAME,
       A.PRODUCT_FAMILY_NAME,
       A.PRODUCT_FAMILY_UID,
       A.REGULATORY_APPLICATION_NAME,
       A.REGULATORY_APPLICATION_UID,
       A.VALIDITY_PERIOD_END,
       A.VALIDITY_PERIOD_START,
       CASE
          WHEN A.VALIDITY_PERIOD_END IS NULL THEN 'Unlimited/No Expiration'
          ELSE TO_CHAR (A.VALIDITY_PERIOD_END, 'MM/DD/YYYY')
       END
          AS Validity_Period,
       B.MEDICINAL_PRODUCT_NAME,
       B.PACKAGED_PRODUCT_NAME,
       E.R_CREATOR_NAME,
       E.R_MODIFY_DATE,
       E.R_MODIFIER,
       E.R_CREATION_DATE,
       E.BUSINESS_UNIT,
       E.CONCEPT,
       E.INFORMATION_CLASSIFICATION,
       E.SECURITY_DOMAIN,
       E.IS_ACTIVE,
       E.object_name AS Authorization_Number,
       C.APPLICATION_NUMBER,
       C.APPLICATION_TYPE_NAME,
       C.TYPE_OF_PROCEDURE,
       C.BASE_APPLICATION_TYPE,
       (SELECT MAX (TR.TRADE_NAME)
          FROM TR
         WHERE MEDICINAL_PRODUCT_UID = B.MEDICINAL_PRODUCT_UID)
          AS TRADE_NAME,
       (SELECT MAX (DOSE_FORM_NAME)
          FROM TR
         WHERE     A.MARKET_UID = MARKET_UID
               AND A.PRODUCT_FAMILY_UID = PRODUCT_FAMILY_UID
               AND HISTORIC_NAME_VALUE = B.MEDICINAL_PRODUCT_NAME)
          AS DOSE_FORM_NAME,
       C.REGULATORY_APPLICATION_R_OBJECT_ID,
       (SELECT MAX (DOSE_STRENGTH_NAME)
          FROM TR
         WHERE     A.MARKET_UID = MARKET_UID
               AND A.PRODUCT_FAMILY_UID = PRODUCT_FAMILY_UID
               AND HISTORIC_NAME_VALUE = B.MEDICINAL_PRODUCT_NAME)
          AS DOSE_STRENGTH_NAME,
       (SELECT MAX (CLASSIFICATION_DOMAIN)
          FROM TR
         WHERE     A.MARKET_UID = MARKET_UID
               AND A.PRODUCT_FAMILY_UID = PRODUCT_FAMILY_UID
               AND HISTORIC_NAME_VALUE = B.MEDICINAL_PRODUCT_NAME)
          AS CLASSIFICATION_DOMAIN,
		  (SELECT MAX (CLASSIFICATION_GROUP)
          FROM TR
         WHERE     A.MARKET_UID = MARKET_UID
               AND A.PRODUCT_FAMILY_UID = PRODUCT_FAMILY_UID
               AND HISTORIC_NAME_VALUE = B.MEDICINAL_PRODUCT_NAME)
          AS CLASSIFICATION_GROUP,
		  (SELECT MAX (CLASSIFICATION_SUBGROUP)
          FROM TR
         WHERE     A.MARKET_UID = MARKET_UID
               AND A.PRODUCT_FAMILY_UID = PRODUCT_FAMILY_UID
               AND HISTORIC_NAME_VALUE = B.MEDICINAL_PRODUCT_NAME)
          AS CLASSIFICATION_SUBGROUP,
       --- 'http://uw00020Qk.abbvienet.dmz:8080/cara/drl/objectId/'|| A.r_object_id|| ''
       'http://uw00016ek:8080/cara/drl/objectId/' || A.r_object_id || ''
          AS Document_URL,
       B.SPECIAL_DESIGNATION,
       B.SPECIAL_DESIGNATION_DATE,
       B.INDICATION_STATUS_DATE,
       B.INDICATION_STATUS,

        M.ROSTER_REGION,(SELECT MAX (IS_EEA)
                FROM COSMOSDBEXPORT.MARKET
               WHERE ISO_COUNTRY_NAME = A.MARKET_NAME)
                 IS_EEA,(SELECT MAX (IS_EU)
                FROM COSMOSDBEXPORT.MARKET
               WHERE ISO_COUNTRY_NAME = A.MARKET_NAME)
               IS_EU
  FROM COSMOSDBEXPORT.PRODUCT_AUTHORISATION A
       INNER JOIN COSMOSDBEXPORT.PRODUCT_AUTHORISATION_R B
          ON A.R_OBJECT_ID = B.PRODUCT_AUTHORISATION_R_OBJECT_ID
       LEFT JOIN COSMOSDBEXPORT.MARKET M on A.market_name = M.ISO_COUNTRY_NAME
       LEFT JOIN
       (SELECT DR.REGULATORY_APPLICATION_R_OBJECT_ID,
               D.APPLICATION_NUMBER,
               D.APPLICATION_TYPE_NAME,
               D.TYPE_OF_PROCEDURE,
               D.BASE_APPLICATION_TYPE,
               C.CONFIG_UID,
               DR.MARKET_NAME,
               (SELECT market_name
                  FROM COSMOSDBEXPORT.REGULATORY_APPLICATION_R
                 WHERE     market_role = 'Rapporteur'
                       AND REGULATORY_APPLICATION_R_OBJECT_ID =
                              DR.REGULATORY_APPLICATION_R_OBJECT_ID)
                  AS REVIEWING_MARKET_NAME,
               DR.market_role
          FROM COSMOSDBEXPORT.REGULATORY_APPLICATION D
               INNER JOIN COSMOSDBEXPORT.REGULATORY_APPLICATION_R DR
                  ON D.R_OBJECT_ID = DR.REGULATORY_APPLICATION_R_OBJECT_ID
               INNER JOIN COSMOSDBEXPORT.OBJECT C
                  ON C.R_OBJECT_ID = D.R_OBJECT_ID) C
          ON C.CONFIG_UID = A.REGULATORY_APPLICATION_UID
       INNER JOIN COSMOSDBEXPORT.OBJECT E ON E.R_OBJECT_ID = A.R_OBJECT_ID),



           second_view as(
select b.*,a.TA  from first_view  b 
left join  VW_TA_PRDFNM a on b.PRODUCT_FAMILY_NAME = a.product
)


select "R_OBJECT_ID","R_INDEX","AUTHORISATION_HOLDER_NAME","AUTHORISATION_HOLDER_UID","AUTHORISATION_STATUS","AUTHORISATION_STATUS_DATE","AUTHORISATION_TYPE","DATE_OF_FIRST_AUTHORISATION","AUTHORIZATION_COUNTRY","MARKET_NAME","REVIEWING_MARKET_NAME","PRODUCT_FAMILY_NAME","PRODUCT_FAMILY_UID","REGULATORY_APPLICATION_NAME","REGULATORY_APPLICATION_UID","VALIDITY_PERIOD_END","VALIDITY_PERIOD_START","VALIDITY_PERIOD","MEDICINAL_PRODUCT_NAME","PACKAGED_PRODUCT_NAME","R_CREATOR_NAME","R_MODIFY_DATE","R_MODIFIER","R_CREATION_DATE","BUSINESS_UNIT","CONCEPT","INFORMATION_CLASSIFICATION","SECURITY_DOMAIN","IS_ACTIVE","AUTHORIZATION_NUMBER","APPLICATION_NUMBER","APPLICATION_TYPE_NAME","TYPE_OF_PROCEDURE","BASE_APPLICATION_TYPE","TRADE_NAME","DOSE_FORM_NAME","REGULATORY_APPLICATION_R_OBJECT_ID","DOSE_STRENGTH_NAME","CLASSIFICATION_DOMAIN","CLASSIFICATION_GROUP","CLASSIFICATION_SUBGROUP","DOCUMENT_URL","SPECIAL_DESIGNATION","SPECIAL_DESIGNATION_DATE","INDICATION_STATUS_DATE","INDICATION_STATUS","ROSTER_REGION","IS_EEA","IS_EU","TA" from second_view;
